{% extends 'base.html' %}

{% block title %}Caixa{% endblock %}

{% block content %}
    <div class="flex-1 w-full p-4 md:p-8">
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center space-x-4">
                <i data-lucide="wallet" class="w-8 h-8 text-primary"></i>
                <h1 class="text-3xl font-bold text-gray-800">Caixa</h1>
            </div>
            <div class="flex space-x-3">
                <a href="{{ url_for('pedidos.index') }}" class="bg-primary text-white font-medium px-4 py-2 rounded-lg shadow-md hover:bg-primary/90 transition-colors">
                    <i data-lucide="list-ordered" class="inline-block w-4 h-4 mr-1"></i>
                    Ver Pedidos
                </a>
                <a href="{{ url_for('caixa.history') }}" class="bg-gray-200 text-secondary font-medium px-4 py-2 rounded-lg shadow-md hover:bg-gray-300 transition-colors">
                    <i data-lucide="history" class="inline-block w-4 h-4 mr-1"></i>
                    Histórico
                </a>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-4">
                    {% for category, message in messages %}
                        <div class="p-3 rounded-lg text-white font-medium mb-2
                        {% if category == 'success' %}bg-success
                        {% elif category == 'danger' %}bg-danger
                        {% elif category == 'warning' %}bg-warning
                        {% else %}bg-primary{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        {% if active_session %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <div id="cash-status-card" class="bg-green-100 rounded-xl shadow-lg p-6 text-center transition-colors duration-300">
                <h5 class="text-success font-bold text-lg mb-2">Caixa Aberto</h5>
                <p class="text-gray-500 text-sm mb-4">Sessão iniciada em: {{ active_session.opened_at.strftime('%d/%m/%Y %H:%M') }}</p>
                <button type="button" class="bg-danger text-white px-4 py-2 rounded-lg shadow-md hover:bg-danger/90 transition-colors" onclick="showModal('close-cash-modal')">
                    <i data-lucide="door-closed" class="inline-block w-4 h-4 mr-1"></i> Fechar Caixa
                </button>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-success mb-4"><i data-lucide="bar-chart-2" class="inline-block w-5 h-5 mr-2"></i> Resumo do Dia</h3>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-600">Vendas Totais:</span>
                    <span id="total-sales" class="text-success font-bold">R$ {{ "%.2f"|format(total_sales) }}</span>
                </div>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-600">Despesas Totais:</span>
                    <span id="total-expenses" class="text-danger font-bold">R$ {{ "%.2f"|format(total_expenses) }}</span>
                </div>
                <hr class="my-4">
                <div class="flex justify-between items-center">
                    <span class="text-gray-800 font-bold">Saldo Atual:</span>
                    <span id="daily-balance" class="text-gray-800 font-bold">R$ {{ "%.2f"|format(current_balance) }}</span>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col items-center justify-center">
                <h3 class="text-xl font-bold text-success mb-4">Novo Pedido de Balcão</h3>
                <button type="button" class="w-full bg-success text-white py-3 px-4 rounded-lg shadow-md hover:bg-success/90 transition-colors flex items-center justify-center space-x-2" onclick="showModal('new-order-modal')">
                    <i data-lucide="plus-square" class="w-5 h-5"></i>
                    <span class="font-semibold">F2 - Abrir Pedido</span>
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Movimentações de Hoje</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descrição</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Horário</th>
                            </tr>
                        </thead>
                        <tbody id="movements-table-body" class="bg-white divide-y divide-gray-200">
                            {% for movement in movements %}
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {% if movement.type == 'sale' %}
                                        <span class="bg-success text-white px-2 py-1 rounded-full text-xs font-semibold">Venda</span>
                                    {% elif movement.type == 'expense' %}
                                        <span class="bg-danger text-white px-2 py-1 rounded-full text-xs font-semibold">Despesa</span>
                                    {% elif movement.type == 'opening' %}
                                        <span class="bg-primary text-white px-2 py-1 rounded-full text-xs font-semibold">Abertura</span>
                                    {% elif movement.type == 'closing' %}
                                        <span class="bg-secondary text-white px-2 py-1 rounded-full text-xs font-semibold">Fechamento</span>
                                    {% elif movement.type == 'deposit' %}
                                        <span class="bg-blue-500 text-white px-2 py-1 rounded-full text-xs font-semibold">Depósito</span>
                                    {% elif movement.type == 'withdrawal' %}
                                        <span class="bg-orange-500 text-white px-2 py-1 rounded-full text-xs font-semibold">Retirada</span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ movement.description }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium 
                                    {% if movement.amount >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    R$ {{ "%.2f"|format(movement.amount) }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ movement.created_at.strftime('%H:%M') }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">Nenhuma movimentação registrada hoje.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-primary mb-4"><i data-lucide="minus-circle" class="inline-block w-5 h-5 mr-2"></i> Registrar Movimentação</h3>
                <form id="add-movement-form" action="{{ url_for('caixa.add_movement') }}" method="post" class="space-y-4">
                    <div>
                        <label for="movement-type" class="block text-sm font-medium text-gray-700">Tipo</label>
                        <select id="movement-type" name="type" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 px-3 py-2">
                            <option value="expense">Despesa</option>
                            <option value="deposit">Depósito</option>
                            <option value="withdrawal">Retirada</option>
                        </select>
                    </div>
                    <div>
                        <label for="movement-description" class="block text-sm font-medium text-gray-700">Descrição</label>
                        <input type="text" id="movement-description" name="description" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 px-3 py-2">
                    </div>
                    <div>
                        <label for="movement-amount" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                        <input type="number" step="0.01" id="movement-amount" name="amount" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 px-3 py-2">
                    </div>
                    <button type="submit" class="w-full bg-primary text-white py-2 px-4 rounded-lg shadow-md hover:bg-primary/90 transition-colors">
                        <i data-lucide="plus-circle" class="inline-block w-4 h-4 mr-1"></i> Registrar
                    </button>
                </form>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Últimas Vendas de Balcão</h3>
            {% if new_counter_orders %}
                <ul class="space-y-4">
                    {% for order in new_counter_orders %}
                        <li class="p-4 border border-gray-200 rounded-lg">
                            <div class="flex justify-between items-center">
                                <div class="flex-1">
                                    <span class="text-sm font-semibold text-gray-600">Pedido #{{ order.id }}</span>
                                    <p class="text-lg font-bold text-primary">R$ {{ "%.2f"|format(order.total_price) }}</p>
                                    <p class="text-xs text-gray-500 mt-1">
                                        <i data-lucide="calendar" class="inline-block w-3 h-3 mr-1"></i>
                                        {{ order.created_at.strftime('%d/%m/%Y %H:%M') }}
                                    </p>
                                    {% if order.notes %}
                                        <div class="mt-2 text-sm text-gray-700 bg-gray-100 p-2 rounded-lg">
                                            <span class="font-medium">Obs:</span> {{ order.notes }}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="flex space-x-2">
                                    <button type="button" onclick="printOrder({{ order.id }})" class="p-2 text-primary hover:bg-primary/10 rounded-full transition-colors">
                                        <i data-lucide="printer" class="w-5 h-5"></i>
                                    </button>
                                    <button type="button" onclick="editOrder({{ order.id }})" class="p-2 text-yellow-500 hover:bg-yellow-500/10 rounded-full transition-colors">
                                        <i data-lucide="pencil" class="w-5 h-5"></i>
                                    </button>
                                    <button type="button" onclick="deleteOrder({{ order.id }})" class="p-2 text-danger hover:bg-danger/10 rounded-full transition-colors">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-gray-500 text-center">Nenhuma venda de balcão registrada hoje.</p>
            {% endif %}
        </div>

<div id="new-order-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-gray-900 bg-opacity-50">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center pb-3 sticky top-0 bg-white z-10">
            <h3 class="text-xl font-bold text-gray-800">Novo Pedido Balcão</h3>
            <button onclick="hideModal('new-order-modal')" class="text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        <form id="counter-order-form">
            <div class="mb-4">
                <label for="product-search" class="block text-sm font-medium text-gray-700">Adicionar produtos</label>
                <input type="text" id="product-search" placeholder="Buscar produto..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                <ul id="product-search-results" class="bg-white border border-gray-300 rounded-md mt-1 absolute w-96 z-10 hidden max-h-48 overflow-y-auto"></ul>
            </div>

            <div class="mb-4">
                <h4 class="text-lg font-bold text-gray-800 mb-2">Itens do Pedido</h4>
                <div id="order-items-list" class="space-y-3 max-h-64 overflow-y-auto pr-2">
                    <p class="text-gray-500 text-sm text-center">Nenhum item adicionado</p>
                </div>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-lg font-bold">Total:</span>
                    <span id="order-total-price" class="text-lg font-bold text-primary">R$ 0,00</span>
                </div>
                <div class="mb-4">
                    <label for="payment-method" class="block text-sm font-medium text-gray-700">Método de Pagamento</label>
                    <select id="payment-method" name="payment_method" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" required>
                        <option value="dinheiro">Dinheiro</option>
                        <option value="cartao">Cartão</option>
                        <option value="pix">PIX</option>
                    </select>
                </div>
                <div id="change-input-group" class="mb-4 hidden">
                    <label for="change-for" class="block text-sm font-medium text-gray-700">Troco para</label>
                    <input type="number" step="0.01" id="change-for" name="change_for" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                    <p class="text-sm text-gray-500 mt-1">Troco: <span id="change-amount" class="font-semibold">R$ 0,00</span></p>
                </div>
                <div class="mb-4">
                    <label for="order-notes" class="block text-sm font-medium text-gray-700">Observação de Finalização</label>
                    <textarea id="order-notes" name="notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary"></textarea>
                </div>
            </div>

            <div class="flex justify-end space-x-3 mt-4">
                <button type="button" onclick="hideModal('new-order-modal')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors">Cancelar</button>
                <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-colors">Finalizar Venda (F2)</button>
            </div>
        </form>
    </div>
</div>

<div id="edit-order-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-gray-900 bg-opacity-50">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center pb-3 sticky top-0 bg-white z-10">
            <h3 class="text-xl font-bold text-gray-800">Editar Pedido de Balcão #<span id="edit-modal-order-id"></span></h3>
            <button onclick="hideModal('edit-order-modal')" class="text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        <form id="edit-order-form">
            <input type="hidden" id="edit-order-id" name="order_id">
            
            <div class="mb-4">
                <label for="edit-product-search" class="block text-sm font-medium text-gray-700">Adicionar mais produtos</label>
                <input type="text" id="edit-product-search" placeholder="Buscar produto..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                <ul id="edit-product-search-results" class="bg-white border border-gray-300 rounded-md mt-1 absolute w-96 z-10 hidden max-h-48 overflow-y-auto"></ul>
            </div>

            <div class="mb-4">
                <h4 class="text-lg font-bold text-gray-800 mb-2">Itens do Pedido</h4>
                <div id="edit-order-items-list" class="space-y-3 pr-2">
                </div>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg sticky bottom-0 z-10">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-lg font-bold">Total:</span>
                    <span id="edit-order-total-price" class="text-lg font-bold text-primary">R$ 0,00</span>
                </div>
                <div class="mb-4">
                    <label for="edit-notes" class="block text-sm font-medium text-gray-700">Observação de Finalização</label>
                    <textarea id="edit-notes" name="notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary"></textarea>
                </div>
            </div>

            <div class="flex justify-end space-x-3 mt-4">
                <button type="button" onclick="hideModal('edit-order-modal')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors">Cancelar</button>
                <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-colors">Salvar Alterações</button>
            </div>
        </form>
    </div>
</div>
        <div id="close-cash-modal" class="modal fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50 transition-opacity duration-300">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 transform transition-transform duration-300 scale-95">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Fechar Caixa</h3>
                <form id="close-cash-form" action="{{ url_for('caixa.close_cash') }}" method="post">
                    <div class="mb-4">
                        <label for="closing-amount" class="block text-sm font-medium text-gray-700">Valor no Caixa (R$)</label>
                        <input type="number" id="closing-amount" name="closing_amount" step="0.01" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2">
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="hideModal('close-cash-modal')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors">Cancelar</button>
                        <button type="submit" class="px-4 py-2 bg-danger text-white rounded-lg font-medium hover:bg-danger/90 transition-colors">Confirmar Fechamento</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="message-modal" class="modal fixed inset-0 z-[60] hidden flex items-center justify-center bg-black bg-opacity-50 transition-opacity duration-300">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 transform transition-transform duration-300 scale-95 text-center">
                <h3 id="message-modal-title" class="text-lg font-semibold mb-2"></h3>
                <p id="message-modal-text" class="text-gray-600 mb-4"></p>
                <button type="button" onclick="hideModal('message-modal')" class="w-full px-4 py-2 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-colors">OK</button>
            </div>
        </div>
        
        <div id="print-modal" class="modal fixed inset-0 z-[60] hidden flex items-center justify-center bg-black bg-opacity-50 transition-opacity duration-300">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4 transform transition-transform duration-300 scale-95">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Comanda do Pedido #<span id="print-order-id"></span></h3>
                    <button type="button" onclick="hideModal('print-modal')" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div id="print-content" class="text-sm font-mono leading-tight space-y-2">
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="printReceipt()" class="px-4 py-2 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-colors">
                        <i data-lucide="printer" class="inline-block w-4 h-4 mr-1"></i> Imprimir
                    </button>
                </div>
            </div>
        </div>

        {% else %}
        <div class="flex items-center justify-center h-[calc(100vh-150px)]">
            <div id="cash-status-card" class="bg-red-100 rounded-xl shadow-lg p-6 text-center max-w-sm w-full">
                <h5 class="text-danger font-bold text-lg mb-2">Caixa Fechado</h5>
                <p class="text-gray-500 text-sm mb-4">Nenhuma sessão de caixa ativa no momento.</p>
                <button type="button" class="bg-success text-white px-4 py-2 rounded-lg shadow-md hover:bg-success/90 transition-colors" onclick="showModal('open-cash-modal')">
                    <i data-lucide="door-open" class="inline-block w-4 h-4 mr-1"></i> Abrir Caixa
                </button>
            </div>
        </div>

        <div id="open-cash-modal" class="modal fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50 transition-opacity duration-300">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 transform transition-transform duration-300 scale-95">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Abrir Caixa</h3>
                <form id="open-cash-form" action="{{ url_for('caixa.open_cash') }}" method="post">
                    <div class="mb-4">
                        <label for="opening-amount" class="block text-sm font-medium text-gray-700">Valor de Abertura (R$)</label>
                        <input type="number" id="opening-amount" name="opening_amount" step="0.01" value="0.00" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm px-3 py-2">
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="hideModal('open-cash-modal')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors">Cancelar</button>
                        <button type="submit" class="px-4 py-2 bg-success text-white rounded-lg font-medium hover:bg-success/90 transition-colors">Abrir</button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
{% endblock %}

{% block extra_js %}
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#4B5563',
                        light: '#E5E7EB',
                        danger: '#EF4444',
                        success: '#22C55E',
                        warning: '#F59E0B',
                        sidebar: '#1E293B',
                    }
                }
            }
        }
    </script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="{{ url_for('static', filename='js/caixa.js') }}" defer></script>

    <style>
        .modal {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
{% endblock %}